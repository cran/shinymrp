<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>MRP methodological guide</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>







<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">MRP methodological guide</h1>



<p>MRP has two key steps: (1) fit a multilevel model for the response
with the adjustment variables based on the input data; and (2)
poststratify using the population distribution of the adjustment
variables, yielding prevalence estimates in the target population and
subgroups.</p>
<div id="mrp-for-cross-sectional-data" class="section level2">
<h2>MRP for cross-sectional data</h2>
<p>We use cross-sectional data to refer to the dataset with measures
collected at a specific time point that does not account for temporal
variation in the modeling or poststratification adjustment. We use a
binary outcome of interest as an example. Let <span class="math inline">\(y_i (=0/1)\)</span> be the binary response for
individual <span class="math inline">\(i\)</span>, with <span class="math inline">\(y_i=1\)</span> indicating the positive response.
We employ a logistic regression with varying effects for age, race, and
ZIP code, where the ZIP-code-level variation is further explained by the
ZIP-code-level predictors. <span class="math display">\[
\label{mrp-1}
\textrm{Pr}(y_i = 1) = \textrm{logit}^{-1}(
\beta_1+\beta_2{\rm male}_i +
\alpha_{\rm a[i]}^{\rm age}
+ \alpha_{\rm r[i]}^{\rm race}
+ \alpha_{\rm s[i]}^{\rm ZIP}
),
\]</span> where <span class="math inline">\({\rm male}_i\)</span> is an
indicator for men, <span class="math inline">\(\alpha_{\rm a}^{\rm
age}\)</span> is the age effect, with a value of <span class="math inline">\(a[i]\)</span> for subject <span class="math inline">\(i\)</span>, on the log-odds function of the
probability of having a positive response, <span class="math inline">\(\alpha_{\rm r}^{\rm race}\)</span> is the racial
effect, and <span class="math inline">\(\alpha_{\rm s}^{\rm
ZIP}\)</span> is the ZIP-code-level effect. In the Bayesian framework,
we assign hierarchical priors to varying intercepts as default: <span class="math display">\[\begin{align}
\label{prior}
\nonumber &amp;\alpha^{\rm age} \sim \mbox{normal}(0,\sigma^{\rm age} ),
\,\,\, \sigma^{\rm age}\sim \mbox{normal}_+ (0,2.5)\\
&amp;\alpha^{\rm race} \sim \mbox{normal}(0,\sigma^{\rm race} ), \,\,\,
\sigma^{\rm race}\sim \mbox{normal}_+ (0,2.5).
\end{align}\]</span> Here <span class="math inline">\(\mbox{normal}_+
(0,2.5)\)</span> represents a half-normal distribution with the mean
<span class="math inline">\(0\)</span> and standard deviation <span class="math inline">\(2.5\)</span> restricted to positive values. As we
have ZIP-code-level predictors <span class="math inline">\(\vec{Z}^{\rm
ZIP}_{s}\)</span>, we need to build another model in which <span class="math inline">\(\alpha_{\rm s}^{\rm ZIP}\)</span> is the outcome
of a linear regression with ZIP-code-level predictors: <span class="math display">\[\begin{align}
\label{prior-zip}
\alpha_{\rm s}^{\rm ZIP} =\vec{\alpha}\vec{Z}^{\rm ZIP}_{s} +  e_s,
\,\,\, e_s\sim \mbox{normal}(0,\sigma^{\rm ZIP} ),\,\,\, \sigma^{\rm
ZIP}\sim \mbox{normal}_+ (0,2.5),
\end{align}\]</span> where <span class="math inline">\(e_s\)</span> is a
ZIP-code-level random error.</p>
<p>The interface allows users to specify alternative priors, including
structured priors for high-order interaction terms developed by <a href="https://www150.statcan.gc.ca/n1/en/pub/12-001-x/2020002/article/00003-eng.pdf?st=iF1_Fbrh">Si
et al. (2020)</a>.</p>
<p>Because the outcome model assumes that the people in the same
poststratification cell share the same response probability, we can
replace the microdata with cell-wise aggregates and employ a binomial
model for the sum of the responses in cell <span class="math inline">\(j\)</span> as <span class="math inline">\(y^*_j
\sim \textrm{binomial}(n_j, \theta_j)\)</span>, where <span class="math inline">\(n_j\)</span> is the sample cell size and <span class="math inline">\(\theta_j=\textrm{logit}^{-1}(
\beta_1+\beta_2{\rm male}_j +
\alpha_{\rm a[j]}^{\rm age}
+ \alpha_{\rm r[j]}^{\rm race}
+ \alpha_{\rm s[j]}^{\rm ZIP}
)\)</span> using the cell-wise effects of all factors. The interface
thus allows users to upload microdata or cell-wise aggregates as the
input data.</p>
<p>To generate overall population or subgroup estimates, we combine
model predictions within the poststratification cells—in the contingency
table of sex, age, race, and ZIP—weighted by the population cell
frequencies <span class="math inline">\(N_j\)</span>, which are derived
from the linked ACS data in our application. Additionally, users may
choose to upload custom poststratification data for specific target
populations (e.g., a different country, rather than the U.S.). If we
write the expected outcome in cell <span class="math inline">\(j\)</span> as <span class="math inline">\(\hat{\theta}_j\)</span> in cell <span class="math inline">\(j\)</span>, the population average from MRP is
then: <span class="math display">\[
\hat{\theta}^{\rm pop} = \frac{\sum_j N_j \hat{\theta}_j}{\sum_j N_j}.
\]</span> The MRP estimator for county <span class="math inline">\(c\)</span> aggregates over covered cells <span class="math inline">\(j\)</span> in that county as, <span class="math display">\[
\hat{\theta}_s^{\rm pop} = \frac{\sum_{j \in \textrm{county c}} N_j
\hat{\theta}_j}{\sum_{j \in \textrm{county c}} N_j}.
\]</span> We implement Bayesian inference for the estimates, where the
variance estimates and 95% credible intervals are computed based on the
posterior samples.</p>
<p>When the outcome is continuous, we specify linear regression models
and estimate residual variance with introduced prior distributions.</p>
</div>
<div id="mrp-for-time-varying-data-with-measurement-error" class="section level2">
<h2>MRP for time-varying data with measurement error</h2>
<p>As an example of time-varying data, we model weekly PCR testing
results. We use a Bayesian framework to account for the PCR testing
sensitivity and specificity. Here, MRP proceeds in two steps: (1) fit a
multilevel model to the testing data for incidence incorporating time
and covariates, and (2) poststratify using the population distribution
of the adjustment variables: sex, age, race, and ZIP codes, where we
assume the population distribution is the same during the study period.
Hence, the poststratification cell is defined by the cross-tabulation of
sex, age, race, ZIP code, and indicators of time in weeks based on the
test result dates.</p>
<p>We denote the PCR test result for individual <span class="math inline">\(i\)</span> as <span class="math inline">\(y_i\)</span>, where <span class="math inline">\(y_i=1\)</span> indicates a positive result and
<span class="math inline">\(y_i=0\)</span> indicates negative.
Similarly, with poststratification cells, we assume that people in the
same cell have the same infection rate and can directly model cell-wise
summaries. We obtain aggregated counts as the number of tests <span class="math inline">\(n_j\)</span> and the number of positive cases
<span class="math inline">\(y^*_j\)</span> in cell <span class="math inline">\(j\)</span>. Let <span class="math inline">\(p_j=\textrm{Pr}(y_{j[i]}=1)\)</span> be the
probability that person <span class="math inline">\(i\)</span> in cell
<span class="math inline">\(j\)</span> tests positive. We account for
the PCR testing sensitivity and specificity, where the positivity <span class="math inline">\(p_j\)</span> is a function of the test sensitivity
<span class="math inline">\(\delta\)</span>, specificity <span class="math inline">\(\gamma\)</span>, and the true incidence <span class="math inline">\(\pi_j\)</span> for people in cell <span class="math inline">\(j\)</span>:<br />
<span class="math display">\[\begin{align}
\label{positivity}
p_j=(1-\gamma)(1-\pi_j )+\delta \pi_j.
\end{align}\]</span></p>
<p>We fit a binomial model for <span class="math inline">\(y^*_j\)</span>, <span class="math inline">\(y^*_j
\sim \textrm{binomial}(n_j, p_j)\)</span> with a logistic regression for
<span class="math inline">\(\pi_j\)</span> with covariates—sex, age,
race, ZIP codes, and time in weeks—to allow time-varying incidence in
the multilevel model. <span class="math display">\[\begin{align}
\label{pi}
\textrm{logit}(\pi_j)=\beta_1+\beta_2{\rm male}_j+\alpha_{{\rm
a}[j]}^{\rm age}+\alpha_{{\rm r}[j]}^{\rm race}+\alpha_{{\rm s}[j]}^{\rm
ZIP}+\alpha_{{\rm t}[j]}^{\rm time},
\end{align}\]</span> where <span class="math inline">\({\rm
male}_j\)</span> is an indicator for men; <span class="math inline">\({\rm a}[j]\)</span>, <span class="math inline">\({\rm r}[j]\)</span>, and <span class="math inline">\({\rm s}[j]\)</span> represent age, race, and ZIP
levels; and <span class="math inline">\({\rm t}[j]\)</span> denotes the
time in weeks when the test result is collected for cell <span class="math inline">\(j\)</span>. We include ZIP-code-level predictors
<span class="math inline">\(\vec{Z}^{\rm ZIP}_{s}\)</span> for ZIP code
<span class="math inline">\(s\)</span>, <span class="math display">\[
\alpha_{s}^{\rm ZIP} =\vec{\alpha}\vec{Z}^{\rm ZIP}_{s} +  e_s.
\]</span> We assign the same priors to those in the cross-sectional case
to varying intercepts and error terms <span class="math inline">\(e_s\)</span>. <span class="math display">\[\begin{align}
\nonumber &amp;\alpha^{\rm age} \sim \mbox{normal}(0,\sigma^{\rm age} ),
\,\,\, \sigma^{\rm age}\sim \mbox{normal}_+ (0,2.5)\\
&amp;\alpha^{\rm race} \sim \mbox{normal}(0,\sigma^{\rm race} ), \,\,\,
\sigma^{\rm race}\sim \mbox{normal}_+ (0,2.5).\\
\alpha_{\rm s}^{\rm ZIP} &amp;=\vec{\alpha}\vec{Z}^{\rm ZIP}_{s} +  e_s,
\,\,\, e_s\sim \mbox{normal}(0,\sigma^{\rm ZIP} ),\,\,\, \sigma^{\rm
ZIP}\sim \mbox{normal}_+ (0,2.5).
\end{align}\]</span></p>
<p>As to time-varying effects, we assume <span class="math inline">\(\alpha_{{\rm t}}^{\rm time} \sim
\mbox{normal}(0,\sigma^{\rm time} )\)</span>, with a weakly informative
hyperprior, <span class="math inline">\(\sigma^{\rm time}\sim
\mbox{normal}_+ (0,5)\)</span>.</p>
<p>As an example, we assign normal priors to the ZIP-code-level and
time-varying effects. The interface leverages Stan’s modeling
capabilities to allow alternative prior choices and can be extended with
advanced modeling.</p>
<p>Using the estimated incidence <span class="math inline">\(\hat{\pi}_j\)</span>, we adjust for selection bias
by applying the sociodemographic distributions in the community with
population cell counts <span class="math inline">\(N_j\)</span> based on
the ACS, yielding population-level weekly incidence estimates: <span class="math display">\[
\hat{\pi}_{t} = \frac{\sum_{j \in \mbox{week,} t}
N_j\hat{\pi}_j}{\sum_{j \in \mbox{week,} t} N_j},
\]</span> which can be restricted to specific subgroups or regions of
interest, as another key property of MRP is to yield robust estimates
for small groups. We obtain the Bayesian credible intervals from the
posterior samples for inference.</p>
</div>
<div id="more-readings" class="section level2">
<h2>More readings</h2>
<ol style="list-style-type: decimal">
<li><p><a href="https://arxiv.org/abs/2405.05909">Y Si, T Tran, J Gabry,
M Morris, and A Gelman (2025), Multilevel Regression and
Poststratification Interface: Application to Track Community-level
COVID-19 Viral Transmission, Population Health Metrics (under
review)</a>.</p></li>
<li><p><a href="http://dx.doi.org/10.1214/24-STS932">Y Si (2025). On the
Use of Auxiliary Variables in Multilevel Regression and
Poststratification, Statistical Science, 40(2), 272–288</a>.</p></li>
<li><p><a href="https://doi.org/10.1097/EDE.0000000000001488">Y Si, L
Covello, S Wang, T Covello, and A Gelman (2022). Beyond Vaccination
Rates: A Synthetic Random Proxy Metric of Total SARS-CoV-2 Immunity
Seroprevalence in the Community, Epidemiology, 33(4),
457–464</a>.</p></li>
<li><p><a href="https://doi.org/10.1097/EDE.0000000000001396">L Covello,
A Gelman, Y Si, and S Wang (2021). Routine Hospital-Based SARS-CoV-2
Testing Outperforms State-Based Data in Predicting Clinical Burden,
Epidemiology, 32(6), 792–799</a>.</p></li>
<li><p><a href="https://www150.statcan.gc.ca/n1/en/pub/12-001-x/2020002/article/00003-eng.pdf?st=iF1_Fbrh">Y
Si, R Trangucci, J Gabry, and A Gelman (2020). Bayesian Hierarchical
Weighting Adjustment and Survey Inference, Survey Methodology, 46(2),
181–214</a>.</p></li>
</ol>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
